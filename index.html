<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeppLink - Мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Темная тема (по умолчанию) */
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #242424;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-primary: #00ff88;
            --accent-secondary: #0088ff;
            --border-color: #333333;
            --shadow-color: rgba(0, 255, 136, 0.1);
            --message-bg: #1a1a1a;
            --message-self-bg: #004d2e;
            --input-bg: #242424;
        }

        .theme-light {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #121212;
            --text-secondary: #666666;
            --accent-primary: #0088ff;
            --accent-secondary: #00aa55;
            --border-color: #dddddd;
            --shadow-color: rgba(0, 136, 255, 0.1);
            --message-bg: #ffffff;
            --message-self-bg: #e3f2fd;
            --input-bg: #ffffff;
        }

        .theme-gray {
            --bg-primary: #2a2a2a;
            --bg-secondary: #363636;
            --bg-tertiary: #424242;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --accent-primary: #00ffff;
            --accent-secondary: #ff6b6b;
            --border-color: #4a4a4a;
            --shadow-color: rgba(0, 255, 255, 0.1);
            --message-bg: #363636;
            --message-self-bg: #004d4d;
            --input-bg: #424242;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
        }

        /* Сайдбар */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                width: 100%;
                height: 100%;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            text-decoration: none;
        }

        .logo i {
            font-size: 28px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .user-profile:hover {
            background: var(--bg-tertiary);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
        }

        .username {
            font-weight: 600;
            font-size: 14px;
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 5px;
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-primary);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .unread-count {
            background: var(--accent-primary);
            color: var(--bg-primary);
            font-size: 12px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* Основной чат */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-status {
            font-size: 13px;
            color: var(--accent-primary);
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .chat-actions button:hover {
            color: var(--accent-primary);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            max-width: 70%;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.self {
            align-self: flex-end;
        }

        .message.other {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            margin-top: 5px;
        }

        .message-content {
            background: var(--message-bg);
            padding: 12px 15px;
            border-radius: 15px;
            border-top-left-radius: 0;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .message.self .message-content {
            background: var(--message-self-bg);
            border-top-left-radius: 15px;
            border-top-right-radius: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
            color: var(--accent-primary);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-actions {
            position: absolute;
            top: -25px;
            right: 10px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            padding: 5px;
            display: none;
            gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
        }

        .message-actions button:hover {
            background: var(--bg-primary);
            color: var(--accent-primary);
        }

        .reply-message {
            background: rgba(255,255,255,0.05);
            border-left: 3px solid var(--accent-primary);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Поле ввода */
        .input-container {
            padding: 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .input-area {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--input-bg);
            border-radius: 25px;
            padding: 10px 20px;
            border: 1px solid var(--border-color);
        }

        .input-area input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            padding: 10px 0;
        }

        .input-actions {
            display: flex;
            gap: 10px;
        }

        .input-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-actions button:hover {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .send-button {
            background: var(--accent-primary);
            color: var(--bg-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--accent-primary);
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFade 0.3s ease;
        }

        @keyframes modalFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--accent-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border 0.2s;
        }

        .form-group input:focus {
            border-color: var(--accent-primary);
        }

        .btn {
            padding: 12px 24px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .avatar-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--accent-primary);
            cursor: pointer;
        }

        .avatar-upload input {
            display: none;
        }

        /* Настройки */
        .settings-container {
            padding: 20px;
        }

        .settings-section {
            background: var(--bg-tertiary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--accent-primary);
        }

        .theme-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .theme-option {
            flex: 1;
            min-width: 100px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .theme-option:hover {
            transform: translateY(-3px);
            border-color: var(--accent-primary);
        }

        .theme-option.active {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .theme-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 10px;
        }

        .theme-dark .theme-preview {
            background: linear-gradient(135deg, #0f0f0f 50%, #00ff88 50%);
        }

        .theme-light .theme-preview {
            background: linear-gradient(135deg, #f5f5f5 50%, #0088ff 50%);
        }

        .theme-gray .theme-preview {
            background: linear-gradient(135deg, #2a2a2a 50%, #00ffff 50%);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .chat-item .last-message {
                display: none;
            }
            
            .chat-avatar {
                width: 40px;
                height: 40px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-image {
                max-width: 200px;
                max-height: 200px;
            }
            
            .mobile-menu-btn {
                display: block !important;
            }
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        /* Индикатор печати */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border-radius: 15px;
            margin: 5px 0;
            max-width: 200px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Загрузка */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 10000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- Сайдбар -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <i class="fas fa-bolt"></i>
                    DeppLink
                </a>
                <div class="user-profile" onclick="toggleSettings()">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=00ff88&color=000" class="avatar" alt="Avatar">
                    <div class="username" id="username">Загрузка...</div>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchUsers" placeholder="Поиск людей..." oninput="searchPeople()">
                </div>
            </div>
            
            <div class="chats-list" id="chatsList">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <div>Загрузка чатов...</div>
                </div>
            </div>
            
            <div class="sidebar-footer" style="padding: 15px; border-top: 1px solid var(--border-color);">
                <button class="btn" onclick="showCreateChat()" style="width: 100%;">
                    <i class="fas fa-plus"></i> Новый чат
                </button>
            </div>
        </div>
        
        <!-- Основной чат -->
        <div class="chat-container">
            <div class="chat-header">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-header-info">
                    <div>
                        <div class="chat-title" id="currentChatName">Выберите чат</div>
                        <div class="chat-status" id="chatStatus"></div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button onclick="showChatInfo()"><i class="fas fa-info-circle"></i></button>
                    <button onclick="showSettings()"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="loading" id="chatLoading">
                    <i class="fas fa-comments"></i>
                    <div>Выберите чат для общения</div>
                </div>
            </div>
            
            <div class="input-container" id="inputContainer" style="display: none;">
                <div class="input-area">
                    <div class="input-actions">
                        <button onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
                        <button onclick="openFilePicker()"><i class="fas fa-paperclip"></i></button>
                    </div>
                    <input type="text" id="messageInput" placeholder="Введите сообщение..." 
                           oninput="handleTyping()" 
                           onkeypress="handleKeyPress(event)">
                    <button class="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div id="typingIndicator"></div>
            </div>
        </div>
        
        <!-- Модалка настроек -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-cog"></i> Настройки</h2>
                    <button class="modal-close" onclick="closeSettings()">&times;</button>
                </div>
                
                <div class="settings-container">
                    <div class="settings-section">
                        <h3 class="settings-title"><i class="fas fa-user"></i> Профиль</h3>
                        <div class="avatar-upload">
                            <img id="settingsAvatar" src="" class="avatar-preview" onclick="document.getElementById('avatarInput').click()">
                            <input type="file" id="avatarInput" accept="image/*" onchange="uploadAvatar(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                                <i class="fas fa-upload"></i> Сменить аватар
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Имя пользователя</label>
                            <input type="text" id="settingsUsername" placeholder="Введите новое имя">
                        </div>
                        <button class="btn" onclick="saveProfile()">
                            <i class="fas fa-save"></i> Сохранить изменения
                        </button>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="settings-title"><i class="fas fa-palette"></i> Тема оформления</h3>
                        <div class="theme-options">
                            <div class="theme-option theme-dark active" onclick="setTheme('dark')">
                                <div class="theme-preview"></div>
                                <div>Темная</div>
                            </div>
                            <div class="theme-option theme-light" onclick="setTheme('light')">
                                <div class="theme-preview"></div>
                                <div>Светлая</div>
                            </div>
                            <div class="theme-option theme-gray" onclick="setTheme('gray')">
                                <div class="theme-preview"></div>
                                <div>Серая</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="settings-title"><i class="fas fa-sign-out-alt"></i> Аккаунт</h3>
                        <button class="btn btn-secondary" onclick="logout()" style="width: 100%;">
                            <i class="fas fa-sign-out-alt"></i> Выйти
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модалка создания чата -->
        <div class="modal" id="createChatModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-plus"></i> Новый чат</h2>
                    <button class="modal-close" onclick="closeCreateChat()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label>Название чата</label>
                    <input type="text" id="chatName" placeholder="Введите название чата">
                </div>
                
                <div class="form-group">
                    <label>Тип чата</label>
                    <select id="chatType" onchange="toggleMemberSelection()">
                        <option value="private">Приватный чат</option>
                        <option value="group">Групповой чат</option>
                    </select>
                </div>
                
                <div class="form-group" id="memberSelection">
                    <label>Выберите участников</label>
                    <div id="userSearchResults" style="max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
                    <input type="text" id="userSearch" placeholder="Начните вводить имя..." oninput="searchUsersForChat()">
                </div>
                
                <button class="btn" onclick="createChat()" style="width: 100%;">
                    <i class="fas fa-check"></i> Создать чат
                </button>
            </div>
        </div>
        
        <!-- Модалка логина/регистрации -->
        <div class="modal" id="authModal" style="display: flex;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-sign-in-alt"></i> DeppLink</h2>
                </div>
                
                <div id="authForm">
                    <div class="form-group">
                        <label>Имя пользователя</label>
                        <input type="text" id="authUsername" placeholder="Введите имя пользователя">
                    </div>
                    
                    <div class="form-group">
                        <label>Пароль</label>
                        <input type="password" id="authPassword" placeholder="Введите пароль">
                    </div>
                    
                    <button class="btn" onclick="login()" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showRegister()" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Регистрация
                    </button>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label>Имя пользователя</label>
                        <input type="text" id="regUsername" placeholder="Введите имя пользователя">
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="regEmail" placeholder="Введите email">
                    </div>
                    
                    <div class="form-group">
                        <label>Пароль</label>
                        <input type="password" id="regPassword" placeholder="Введите пароль">
                    </div>
                    
                    <button class="btn" onclick="register()" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-check"></i> Зарегистрироваться
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showLogin()" style="width: 100%;">
                        <i class="fas fa-arrow-left"></i> Назад к входу
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Уведомления -->
        <div class="notification" id="notification"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        let socket = null;
        let currentUser = null;
        let currentChatId = null;
        let usersForChat = [];
        let selectedUsers = [];

        // Инициализация
        document.addEventListener('DOMContentLoaded', async () => {
            // Проверяем сохраненную сессию
            const savedUser = localStorage.getItem('deeplink_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await loadUserData();
                    initSocket();
                } catch (e) {
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
            
            // Загружаем чаты
            loadChats();
            
            // Загружаем тему
            loadTheme();
        });

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('authForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('authForm').style.display = 'block';
        }

        async function login() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('deeplink_user', JSON.stringify(currentUser));
                    hideAuthModal();
                    await loadUserData();
                    initSocket();
                    loadChats();
                    showNotification('Вход выполнен успешно!');
                } else {
                    showNotification(data.error || 'Ошибка входа');
                }
            } catch (error) {
                showNotification('Ошибка соединения');
            }
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, email, password})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Регистрация успешна! Теперь войдите.');
                    showLogin();
                } else {
                    showNotification(data.error || 'Ошибка регистрации');
                }
            } catch (error) {
                showNotification('Ошибка соединения');
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('username').textContent = user.username;
                    document.getElementById('userAvatar').src = user.avatar || 'https://ui-avatars.com/api/?name=' + user.username;
                    document.getElementById('settingsUsername').value = user.username;
                    document.getElementById('settingsAvatar').src = user.avatar || 'https://ui-avatars.com/api/?name=' + user.username;
                    
                    // Устанавливаем тему
                    setTheme(user.theme || 'dark', false);
                }
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
            }
        }

        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
            });
            
            socket.on('new_message', (message) => {
                console.log('New message:', message);
                if (message.chat_id === currentChatId) {
                    addMessageToChat(message);
                }
                updateChatList(message);
            });
            
            socket.on('message_sent', (data) => {
                if (data.chat_id !== currentChatId) {
                    updateChatInList(data);
                }
            });
            
            socket.on('user_typing', (data) => {
                if (data.chat_id === currentChatId) {
                    showTypingIndicator(data.username);
                }
            });
            
            socket.on('message_deleted', (data) => {
                if (data.chat_id === currentChatId) {
                    document.querySelector(`.message[data-id="${data.message_id}"]`)?.remove();
                }
            });
            
            socket.on('user_status', (data) => {
                updateUserStatus(data);
            });
            
            socket.on('user_updated', (data) => {
                if (currentUser && data.user_id === currentUser.id) {
                    currentUser.username = data.username;
                    currentUser.avatar = data.avatar;
                    localStorage.setItem('deeplink_user', JSON.stringify(currentUser));
                    loadUserData();
                }
            });
        }

        async function loadChats() {
            try {
                const response = await fetch('/api/chats');
                if (response.ok) {
                    const chats = await response.json();
                    renderChats(chats);
                }
            } catch (error) {
                console.error('Ошибка загрузки чатов:', error);
            }
        }

        function renderChats(chats) {
            const container = document.getElementById('chatsList');
            if (chats.length === 0) {
                container.innerHTML = '<div class="loading"><div>Нет чатов</div></div>';
                return;
            }
            
            container.innerHTML = chats.map(chat => `
                <div class="chat-item" data-id="${chat.id}" onclick="selectChat(${chat.id})">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(chat.name)}&background=00ff88&color=000" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${escapeHtml(chat.name)}</div>
                        <div class="last-message">${escapeHtml(chat.last_message?.content || '')}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${formatTime(chat.last_message?.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function selectChat(chatId) {
            currentChatId = chatId;
            
            // Показываем активный чат
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.chat-item[data-id="${chatId}"]`)?.classList.add('active');
            
            // Загружаем сообщения
            await loadMessages(chatId);
            
            // Показываем поле ввода
            document.getElementById('inputContainer').style.display = 'block';
            document.getElementById('chatLoading').style.display = 'none';
            
            // Присоединяемся к комнате чата
            if (socket) {
                socket.emit('join_chat', {chat_id: chatId});
            }
            
            // На мобильных скрываем сайдбар
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        async function loadMessages(chatId) {
            try {
                const response = await fetch(`/api/chat/${chatId}/messages`);
                if (response.ok) {
                    const messages = await response.json();
                    renderMessages(messages);
                }
            } catch (error) {
                console.error('Ошибка загрузки сообщений:', error);
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="loading"><div>Нет сообщений</div></div>';
                return;
            }
            
            messages.forEach(message => {
                if (!message.is_deleted) {
                    addMessageToChat(message);
                }
            });
            
            // Скроллим вниз
            container.scrollTop = container.scrollHeight;
        }

        function addMessageToChat(message) {
            const container = document.getElementById('messagesContainer');
            const isSelf = message.user_id === currentUser?.id;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSelf ? 'self' : 'other'}`;
            messageElement.setAttribute('data-id', message.id);
            
            let contentHtml = '';
            if (message.type === 'image') {
                contentHtml = `<img src="${message.media_url}" class="message-image" onclick="viewImage('${message.media_url}')">`;
            } else {
                contentHtml = `<div class="message-text">${escapeHtml(message.content)}</div>`;
            }
            
            messageElement.innerHTML = `
                ${!isSelf ? `<img src="${message.avatar || 'https://ui-avatars.com/api/?name=' + message.username}" class="message-avatar">` : ''}
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-sender">${escapeHtml(message.username)}</div>
                        <div class="message-time">${formatTime(message.created_at)}</div>
                    </div>
                    ${message.reply_to ? '<div class="reply-message">Ответ на сообщение</div>' : ''}
                    ${contentHtml}
                    <div class="message-actions">
                        ${!isSelf ? `<button onclick="replyToMessage(${message.id})"><i class="fas fa-reply"></i></button>` : ''}
                        ${isSelf ? `<button onclick="deleteMessage(${message.id})"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChatId || !socket) return;
            
            socket.emit('send_message', {
                chat_id: currentChatId,
                content: content,
                type: 'text'
            });
            
            input.value = '';
            hideTypingIndicator();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleTyping() {
            if (currentChatId && socket) {
                socket.emit('typing', {chat_id: currentChatId});
            }
        }

        let typingTimeout;
        function showTypingIndicator(username) {
            const indicator = document.getElementById('typingIndicator');
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    ${username} печатает...
                </div>
            `;
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(hideTypingIndicator, 3000);
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').innerHTML = '';
        }

        function deleteMessage(messageId) {
            if (socket && confirm('Удалить сообщение?')) {
                socket.emit('delete_message', {message_id: messageId});
            }
        }

        // Настройки
        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        async function saveProfile() {
            const username = document.getElementById('settingsUsername').value;
            
            try {
                const response = await fetch('/api/user/update', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username})
                });
                
                if (response.ok) {
                    showNotification('Профиль обновлен!');
                    await loadUserData();
                } else {
                    showNotification('Ошибка обновления');
                }
            } catch (error) {
                showNotification('Ошибка соединения');
            }
        }

        async function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                
                try {
                    const response = await fetch('/api/user/update', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({avatar: base64})
                    });
                    
                    if (response.ok) {
                        showNotification('Аватар обновлен!');
                        await loadUserData();
                    }
                } catch (error) {
                    showNotification('Ошибка загрузки аватара');
                }
            };
            reader.readAsDataURL(file);
        }

        function setTheme(theme, save = true) {
            document.body.className = `theme-${theme}`;
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
            document.querySelector(`.theme-option.theme-${theme}`)?.classList.add('active');
            
            if (save && currentUser) {
                fetch('/api/user/update', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({theme})
                });
                
                // Обновляем локальные данные
                currentUser.theme = theme;
                localStorage.setItem('deeplink_user', JSON.stringify(currentUser));
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('deeplink_theme');
            if (savedTheme) {
                setTheme(savedTheme, false);
            }
        }

        // Поиск людей
        async function searchPeople() {
            const query = document.getElementById('searchUsers').value;
            if (query.length < 2) return;
            
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                if (response.ok) {
                    const users = await response.json();
                    showSearchResults(users);
                }
            } catch (error) {
                console.error('Ошибка поиска:', error);
            }
        }

        function showSearchResults(users) {
            const container = document.getElementById('chatsList');
            if (users.length === 0) {
                container.innerHTML = '<div class="loading"><div>Ничего не найдено</div></div>';
                return;
            }
            
            container.innerHTML = users.map(user => `
                <div class="chat-item" onclick="startChatWithUser(${user.id})">
                    <img src="${user.avatar || 'https://ui-avatars.com/api/?name=' + user.username}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${escapeHtml(user.username)}</div>
                        <div class="last-message">${user.status === 'online' ? '🟢 В сети' : '⚫ Не в сети'}</div>
                    </div>
                </div>
            `).join('');
        }

        async function startChatWithUser(userId) {
            try {
                const response = await fetch('/api/chat/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'private',
                        members: [userId]
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    selectChat(data.chat_id);
                    loadChats();
                }
            } catch (error) {
                showNotification('Ошибка создания чата');
            }
        }

        // Создание чата
        function showCreateChat() {
            document.getElementById('createChatModal').classList.add('active');
        }

        function closeCreateChat() {
            document.getElementById('createChatModal').classList.remove('active');
            selectedUsers = [];
        }

        async function searchUsersForChat() {
            const query = document.getElementById('userSearch').value;
            if (query.length < 2) return;
            
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                if (response.ok) {
                    usersForChat = await response.json();
                    renderUsersForChat();
                }
            } catch (error) {
                console.error('Ошибка поиска:', error);
            }
        }

        function renderUsersForChat() {
            const container = document.getElementById('userSearchResults');
            container.innerHTML = usersForChat.map(user => `
                <div class="chat-item" onclick="toggleUserSelection(${user.id})">
                    <img src="${user.avatar || 'https://ui-avatars.com/api/?name=' + user.username}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${escapeHtml(user.username)}</div>
                    </div>
                    <div class="chat-meta">
                        <input type="checkbox" id="user_${user.id}" ${selectedUsers.includes(user.id) ? 'checked' : ''}>
                    </div>
                </div>
            `).join('');
        }

        function toggleUserSelection(userId) {
            const index = selectedUsers.indexOf(userId);
            if (index === -1) {
                selectedUsers.push(userId);
            } else {
                selectedUsers.splice(index, 1);
            }
            renderUsersForChat();
        }

        async function createChat() {
            const name = document.getElementById('chatName').value || 'Новый чат';
            const type = document.getElementById('chatType').value;
            
            try {
                const response = await fetch('/api/chat/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        type: type,
                        members: selectedUsers
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    showNotification('Чат создан!');
                    closeCreateChat();
                    loadChats();
                    selectChat(data.chat_id);
                }
            } catch (error) {
                showNotification('Ошибка создания чата');
            }
        }

        // Вспомогательные функции
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function logout() {
            fetch('/api/logout', {method: 'POST'});
            localStorage.removeItem('deeplink_user');
            location.reload();
        }

        // Эмодзи и файлы (заглушки)
        function toggleEmojiPicker() {
            showNotification('Выбор эмодзи будет добавлен в следующем обновлении');
        }

        function openFilePicker() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file || !currentChatId || !socket) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    socket.emit('send_message', {
                        chat_id: currentChatId,
                        content: 'Изображение',
                        type: 'image',
                        media_url: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function viewImage(url) {
            window.open(url, '_blank');
        }

        function replyToMessage(messageId) {
            showNotification('Ответ на сообщение будет добавлен в следующем обновлении');
        }
    </script>
</body>
</html>
