<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeppLink - –°—É–ø–µ—Ä –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
            --bg-main: #0a0a0a;
            --bg-card: #141414;
            --bg-input: #1e1e1e;
            --bg-message: #1a1a1a;
            --bg-self: #005c3a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --accent-green: #00ff88;
            --accent-blue: #00a8ff;
            --accent-purple: #9d4edd;
            --border: #2a2a2a;
            --shadow: rgba(0, 255, 136, 0.1);
        }

        .theme-light {
            --bg-main: #f5f7fa;
            --bg-card: #ffffff;
            --bg-input: #f0f2f5;
            --bg-message: #ffffff;
            --bg-self: #e3f2fd;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent-green: #00c853;
            --accent-blue: #2979ff;
            --accent-purple: #7b1fa2;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        .theme-gray {
            --bg-main: #1e1e1e;
            --bg-card: #2d2d2d;
            --bg-input: #3a3a3a;
            --bg-message: #252525;
            --bg-self: #004d4d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --accent-green: #00ffff;
            --accent-blue: #4fc3f7;
            --accent-purple: #ba68c8;
            --border: #404040;
            --shadow: rgba(0, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 350px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 5px 0 20px var(--shadow);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo i {
            font-size: 32px;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-panel:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-green);
        }

        .user-info {
            flex: 1;
        }

        .username {
            font-weight: 600;
            font-size: 15px;
        }

        .user-status {
            font-size: 12px;
            color: var(--accent-green);
        }

        /* –ü–æ–∏—Å–∫ */
        .search-container {
            padding: 20px;
            position: relative;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px var(--shadow);
        }

        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .chat-item:hover {
            background: var(--bg-input);
            border-color: var(--border);
            transform: translateX(5px);
        }

        .chat-item.active {
            background: var(--bg-input);
            border-left: 4px solid var(--accent-green);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid;
            border-image: linear-gradient(45deg, var(--accent-green), var(--accent-blue)) 1;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .unread-badge {
            background: var(--accent-green);
            color: var(--bg-main);
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
            position: relative;
        }

        .chat-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .chat-status {
            font-size: 13px;
            color: var(--accent-green);
            font-weight: 500;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-input);
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--accent-green);
            color: var(--bg-main);
            transform: rotate(15deg) scale(1.1);
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: var(--bg-main);
        }

        .message {
            display: flex;
            max-width: 75%;
            animation: messageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.self {
            align-self: flex-end;
        }

        .message.other {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 12px;
            margin-top: 5px;
            border: 2px solid var(--accent-green);
        }

        .message-content {
            background: var(--bg-message);
            padding: 16px 20px;
            border-radius: 20px;
            border-top-left-radius: 5px;
            box-shadow: 0 4px 15px var(--shadow);
            position: relative;
            min-width: 120px;
        }

        .message.self .message-content {
            background: var(--bg-self);
            border-top-left-radius: 20px;
            border-top-right-radius: 5px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 700;
            font-size: 14px;
            color: var(--accent-green);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-image {
            max-width: 300px;
            border-radius: 15px;
            margin-top: 10px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .message-image:hover {
            transform: scale(1.03);
        }

        .message-actions {
            position: absolute;
            top: -30px;
            right: 10px;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 6px;
            display: none;
            gap: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        .message:hover .message-actions {
            display: flex;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent-green);
            color: var(--bg-main);
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .input-container {
            padding: 25px 30px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            backdrop-filter: blur(10px);
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-input);
            border-radius: 30px;
            padding: 8px 8px 8px 25px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 4px var(--shadow);
        }

        .input-wrapper input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            padding: 12px 0;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-action {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-action:hover {
            background: var(--border);
            color: var(--accent-green);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .send-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 25px var(--shadow);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-input);
            border-radius: 20px;
            margin: 10px 0;
            max-width: 200px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFade 0.3s ease-out;
            backdrop-filter: blur(10px);
        }

        @keyframes modalFade {
            from { opacity: 0; backdrop-filter: blur(0); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 25px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            position: relative;
            animation: modalSlide 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalSlide {
            from { transform: translateY(50px) scale(0.9); }
            to { transform: translateY(0) scale(1); }
        }

        .modal-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .modal-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 15px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 4px var(--shadow);
        }

        .btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            margin-top: 15px;
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-grid {
            display: grid;
            gap: 20px;
            margin-top: 30px;
        }

        .settings-card {
            background: var(--bg-input);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .settings-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-green);
        }

        .settings-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .theme-option {
            flex: 1;
            min-width: 140px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .theme-option:hover {
            transform: scale(1.05);
        }

        .theme-option.active {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px var(--shadow);
        }

        .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 3px solid;
        }

        .theme-dark .theme-preview {
            background: linear-gradient(135deg, #0a0a0a 50%, #00ff88 50%);
            border-color: #00ff88;
        }

        .theme-light .theme-preview {
            background: linear-gradient(135deg, #f5f7fa 50%, #00c853 50%);
            border-color: #00c853;
        }

        .theme-gray .theme-preview {
            background: linear-gradient(135deg, #1e1e1e 50%, #00ffff 50%);
            border-color: #00ffff;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10000;
            max-width: 350px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            font-size: 24px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                width: 100%;
                height: 100%;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-toggle {
                display: block !important;
            }
            
            .chat-header-left .chat-title {
                font-size: 18px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-image {
                max-width: 250px;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            font-size: 40px;
            margin-bottom: 20px;
            color: var(--accent-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--accent-green), var(--accent-blue));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(var(--accent-blue), var(--accent-green));
        }

        /* –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--border);
        }

        /* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
        .avatar-upload {
            text-align: center;
            margin: 30px 0;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--accent-green);
            margin: 0 auto 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px var(--shadow);
        }

        .avatar-preview:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .avatar-input {
            display: none;
        }
    </style>
</head>
<body class="theme-dark">
    <div class="app-container">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-bolt"></i>
                    <span>DeppLink</span>
                </div>
                <div class="user-panel" onclick="openSettings()">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=00ff88&color=000" class="avatar">
                    <div class="user-info">
                        <div class="username" id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div class="user-status" id="userStatus">‚ö™ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –∏ —á–∞—Ç–æ–≤..." 
                           oninput="handleGlobalSearch()">
                </div>
            </div>

            <div class="chats-list" id="chatsList">
                <div class="loading">
                    <i class="fas fa-spinner loading-spinner"></i>
                    <div>–ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã...</div>
                </div>
            </div>

            <div class="sidebar-footer" style="padding: 20px; border-top: 1px solid var(--border);">
                <button class="btn" onclick="openCreateChat()" style="width: 100%;">
                    <i class="fas fa-plus-circle"></i> –ù–æ–≤—ã–π —á–∞—Ç
                </button>
            </div>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
        <main class="chat-container">
            <header class="chat-header">
                <div class="chat-header-left">
                    <button class="mobile-toggle icon-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <div class="chat-title" id="currentChatName">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DeppLink! üëã</div>
                        <div class="chat-status" id="chatStatus">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" onclick="openChatInfo()" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="icon-btn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button class="icon-btn" onclick="openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3 style="margin-bottom: 10px; color: var(--text-primary);">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</h3>
                    <p style="color: var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
                </div>
            </div>

            <div class="input-container" id="inputContainer" style="display: none;">
                <div class="input-wrapper">
                    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           oninput="handleTyping()" onkeypress="handleKeyPress(event)">
                    <div class="input-actions">
                        <button class="input-action" onclick="openEmojiPicker()" title="–≠–º–æ–¥–∑–∏">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="input-action" onclick="openFilePicker()" title="–§–æ—Ç–æ/—Ñ–∞–π–ª">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="send-btn" onclick="sendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div id="typingIndicator"></div>
            </div>
        </main>

        <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div class="modal active" id="authModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title">DeppLink</h1>
                    <p class="modal-subtitle">–°—É–ø–µ—Ä –±—ã—Å—Ç—Ä—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</p>
                </div>
                
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername"><i class="fas fa-user"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º">
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    
                    <button class="btn" onclick="performLogin()">
                        <i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showRegisterForm()">
                        <i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                </div>

                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="regUsername"><i class="fas fa-user"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫">
                    </div>
                    
                    <div class="form-group">
                        <label for="regPassword"><i class="fas fa-lock"></i> –ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="regPassword" class="form-control" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤">
                    </div>
                    
                    <button class="btn" onclick="performRegister()">
                        <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                    
                    <button class="btn btn-secondary" onclick="showLoginForm()">
                        <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É
                    </button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title"><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                    <p class="modal-subtitle">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤–∞—à DeppLink</p>
                </div>
                
                <div class="avatar-upload">
                    <img id="settingsAvatar" class="avatar-preview" 
                         onclick="document.getElementById('avatarUpload').click()">
                    <input type="file" id="avatarUpload" class="avatar-input" accept="image/*" onchange="uploadAvatar(this)">
                    <p style="color: var(--text-secondary); margin-top: 10px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
                </div>
                
                <div class="form-group">
                    <label for="settingsUsername"><i class="fas fa-id-card"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="settingsUsername" class="form-control" placeholder="–í–∞—à–µ –∏–º—è –≤ —Å–∏—Å—Ç–µ–º–µ">
                </div>
                
                <div class="settings-grid">
                    <div class="settings-card">
                        <div class="settings-title"><i class="fas fa-palette"></i> –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</div>
                        <div class="theme-selector">
                            <div class="theme-option theme-dark active" onclick="changeTheme('dark')">
                                <div class="theme-preview"></div>
                                <div>–¢–µ–º–Ω–∞—è</div>
                            </div>
                            <div class="theme-option theme-light" onclick="changeTheme('light')">
                                <div class="theme-preview"></div>
                                <div>–°–≤–µ—Ç–ª–∞—è</div>
                            </div>
                            <div class="theme-option theme-gray" onclick="changeTheme('gray')">
                                <div class="theme-preview"></div>
                                <div>–°–µ—Ä–∞—è</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="saveSettings()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
                
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                </button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ -->
        <div class="modal" id="createChatModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title"><i class="fas fa-plus-circle"></i> –ù–æ–≤—ã–π —á–∞—Ç</h1>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ (–¥–ª—è –≥—Ä—É–ø–ø—ã)</label>
                    <input type="text" id="chatName" class="form-control" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-users"></i> –¢–∏–ø —á–∞—Ç–∞</label>
                    <select id="chatType" class="form-control" onchange="toggleChatType()">
                        <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç (1 –Ω–∞ 1)</option>
                        <option value="group">–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                    <div id="chatMembers" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
                    <input type="text" id="userSearchInput" class="form-control" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." 
                           oninput="searchUsersForChat()">
                </div>
                
                <button class="btn" onclick="createNewChat()">
                    <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
                </button>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
        <div class="notification" id="notification"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket = null;
        let currentUser = null;
        let currentChatId = null;
        let chats = [];
        let usersCache = {};
        let selectedUsers = [];
        let typingTimeout = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
            const savedUser = localStorage.getItem('deeplink_user');
            const savedTheme = localStorage.getItem('deeplink_theme') || 'dark';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
            document.body.className = `theme-${savedTheme}`;
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await initializeApp();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                    showAuthModal();
                }
            } else {
                showAuthModal();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
            loadChats();
        });

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        async function performLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!username || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('deeplink_user', JSON.stringify(currentUser));
                    hideAuthModal();
                    await initializeApp();
                    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        async function performRegister() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            if (!username || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.', 'success');
                    showLoginForm();
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = password;
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        async function initializeApp() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUserInterface();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket
            initSocket();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserData();
        }

        function updateUserInterface() {
            if (currentUser) {
                document.getElementById('username').textContent = currentUser.username;
                document.getElementById('userAvatar').src = getAvatarUrl(currentUser.avatar, currentUser.username);
                document.getElementById('settingsUsername').value = currentUser.username;
                document.getElementById('settingsAvatar').src = getAvatarUrl(currentUser.avatar, currentUser.username);
                document.getElementById('userStatus').textContent = 'üü¢ –í —Å–µ—Ç–∏';
                document.getElementById('userStatus').style.color = 'var(--accent-green)';
            }
        }

        function getAvatarUrl(avatar, username) {
            if (avatar && avatar !== 'default') {
                return avatar;
            }
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=00ff88&color=000&bold=true`;
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    localStorage.setItem('deeplink_user', JSON.stringify(user));
                    updateUserInterface();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
                if (currentChatId) {
                    socket.emit('join_chat', {chat_id: currentChatId});
                }
            });
            
            socket.on('new_message', (message) => {
                console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                
                if (message.chat_id === currentChatId) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                    addMessageToChat(message);
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    updateChatInList(message.chat_id, message.content);
                }
            });
            
            socket.on('user_typing', (data) => {
                if (data.chat_id === currentChatId) {
                    showTypingIndicator(data.username);
                }
            });
            
            socket.on('user_status', (data) => {
                updateUserStatus(data);
            });
            
            socket.on('message_deleted', (data) => {
                if (data.chat_id === currentChatId) {
                    removeMessage(data.message_id);
                }
            });
            
            socket.on('user_updated', (data) => {
                if (currentUser && data.user_id === currentUser.id) {
                    currentUser.username = data.username;
                    currentUser.avatar = data.avatar;
                    localStorage.setItem('deeplink_user', JSON.stringify(currentUser));
                    updateUserInterface();
                }
            });
        }

        async function loadChats() {
            try {
                const response = await fetch('/api/chats');
                if (response.ok) {
                    chats = await response.json();
                    renderChats();
                } else if (response.status === 401) {
                    showAuthModal();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
            }
        }

        function renderChats() {
            const container = document.getElementById('chatsList');
            
            if (!chats || chats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: var(--text-primary);">–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                        <p style="color: var(--text-secondary);">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–µ–º-–Ω–∏–±—É–¥—å!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = chats.map(chat => `
                <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" 
                     data-id="${chat.id}" 
                     onclick="selectChat(${chat.id}, '${escapeHtml(chat.name)}')">
                    <img src="${getAvatarUrl('', chat.name)}" class="chat-avatar" alt="${chat.name}">
                    <div class="chat-info">
                        <div class="chat-name">${escapeHtml(chat.name)}</div>
                        <div class="last-message">${escapeHtml(chat.last_message?.content || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π')}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${formatTime(chat.last_message?.time)}</div>
                        ${chat.unread_count > 0 ? `<div class="unread-badge">${chat.unread_count}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function selectChat(chatId, chatName) {
            if (currentChatId === chatId) return;
            
            currentChatId = chatId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('currentChatName').textContent = chatName;
            document.getElementById('chatStatus').textContent = 'üü¢ –û–Ω–ª–∞–π–Ω';
            document.getElementById('inputContainer').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.chat-item[data-id="${chatId}"]`)?.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            await loadMessages(chatId);
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞
            if (socket) {
                socket.emit('join_chat', {chat_id: chatId});
            }
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        async function loadMessages(chatId) {
            try {
                const response = await fetch(`/api/chat/${chatId}/messages`);
                if (response.ok) {
                    const messages = await response.json();
                    renderMessages(messages);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comment-slash"></i>
                        </div>
                        <h3 style="margin-bottom: 10px; color: var(--text-primary);">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        <p style="color: var(--text-secondary);">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                addMessageToChat(message);
            });
            
            // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
            container.scrollTop = container.scrollHeight;
        }

        function addMessageToChat(message) {
            const container = document.getElementById('messagesContainer');
            
            // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω –µ—Å–ª–∏ –µ—Å—Ç—å
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.is_self ? 'self' : 'other'}`;
            messageElement.setAttribute('data-id', message.id);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
            const time = formatTime(message.created_at);
            
            messageElement.innerHTML = `
                ${!message.is_self ? `
                    <img src="${getAvatarUrl(message.avatar, message.username)}" 
                         class="message-avatar" 
                         alt="${escapeHtml(message.username)}"
                         title="${escapeHtml(message.username)}">
                ` : ''}
                
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-sender">${escapeHtml(message.username)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                    
                    <div class="message-text">
                        ${escapeHtml(message.content)}
                    </div>
                    
                    <div class="message-actions">
                        ${!message.is_self ? `
                            <button class="action-btn" onclick="replyToMessage(${message.id})" title="–û—Ç–≤–µ—Ç–∏—Ç—å">
                                <i class="fas fa-reply"></i>
                            </button>
                        ` : ''}
                        
                        ${message.is_self ? `
                            <button class="action-btn" onclick="deleteMessage(${message.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(messageElement);
            
            // –°–∫—Ä–æ–ª–ª–∏–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChatId || !socket) {
                return;
            }
            
            socket.emit('send_message', {
                chat_id: currentChatId,
                content: content,
                type: 'text'
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
            input.focus();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
            hideTypingIndicator();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleTyping() {
            if (!currentChatId || !socket) return;
            
            socket.emit('typing', {chat_id: currentChatId});
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            typingTimeout = setTimeout(hideTypingIndicator, 3000);
        }

        function showTypingIndicator(username) {
            const container = document.getElementById('typingIndicator');
            
            // –£–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            hideTypingIndicator();
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                ${escapeHtml(username)} –ø–µ—á–∞—Ç–∞–µ—Ç...
            `;
            
            container.appendChild(indicator);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (indicator.parentNode === container) {
                    container.removeChild(indicator);
                }
            }, 3000);
        }

        function hideTypingIndicator() {
            const container = document.getElementById('typingIndicator');
            container.innerHTML = '';
        }

        async function deleteMessage(messageId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            try {
                const response = await fetch('/api/message/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message_id: messageId})
                });
                
                if (response.ok) {
                    removeMessage(messageId);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }

        function removeMessage(messageId) {
            const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function saveSettings() {
            const username = document.getElementById('settingsUsername').value.trim();
            
            if (!username) {
                showNotification('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/user/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await loadUserData();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    loadChats();
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function uploadAvatar(input) {
            const file = input.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const response = await fetch('/api/user/update', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({avatar: e.target.result})
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                        await loadUserData();
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        function changeTheme(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('deeplink_theme', theme);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–µ–º—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.querySelector(`.theme-option.theme-${theme}`).classList.add('active');
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('deeplink_theme') || 'dark';
            const themes = ['dark', 'light', 'gray'];
            const nextIndex = (themes.indexOf(currentTheme) + 1) % themes.length;
            changeTheme(themes[nextIndex]);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
        function openCreateChat() {
            document.getElementById('createChatModal').classList.add('active');
            selectedUsers = [];
            renderSelectedUsers();
        }

        function closeCreateChat() {
            document.getElementById('createChatModal').classList.remove('active');
        }

        function toggleChatType() {
            const type = document.getElementById('chatType').value;
            document.getElementById('chatName').style.display = type === 'group' ? 'block' : 'none';
        }

        async function searchUsersForChat() {
            const query = document.getElementById('userSearchInput').value.trim();
            
            if (query.length < 2) {
                return;
            }
            
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                if (response.ok) {
                    const users = await response.json();
                    renderUserSearchResults(users);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            }
        }

        function renderUserSearchResults(users) {
            const container = document.getElementById('chatMembers');
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'searchResults';
            
            if (users.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 10px; color: var(--text-secondary); text-align: center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                resultsContainer.innerHTML = users.map(user => `
                    <div class="chat-item" onclick="addUserToChat(${user.id}, '${escapeHtml(user.username)}')">
                        <img src="${getAvatarUrl(user.avatar, user.username)}" class="chat-avatar">
                        <div class="chat-info">
                            <div class="chat-name">${escapeHtml(user.username)}</div>
                            <div class="last-message">${user.status === 'online' ? 'üü¢ –í —Å–µ—Ç–∏' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏'}</div>
                        </div>
                        <div class="chat-meta">
                            <i class="fas fa-plus" style="color: var(--accent-green);"></i>
                        </div>
                    </div>
                `).join('');
            }
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞
            const existingResults = document.getElementById('searchResults');
            if (existingResults) {
                existingResults.remove();
            }
            
            container.parentNode.insertBefore(resultsContainer, container.nextSibling);
        }

        function addUserToChat(userId, username) {
            if (!selectedUsers.some(u => u.id === userId)) {
                selectedUsers.push({id: userId, username});
                renderSelectedUsers();
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                document.getElementById('userSearchInput').value = '';
                const results = document.getElementById('searchResults');
                if (results) results.remove();
            }
        }

        function renderSelectedUsers() {
            const container = document.getElementById('chatMembers');
            
            if (selectedUsers.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); padding: 10px; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞</div>';
                return;
            }
            
            container.innerHTML = selectedUsers.map(user => `
                <div class="chat-item" style="margin-bottom: 8px;">
                    <img src="${getAvatarUrl('', user.username)}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${escapeHtml(user.username)}</div>
                    </div>
                    <div class="chat-meta">
                        <button class="action-btn" onclick="removeUserFromChat(${user.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeUserFromChat(userId) {
            selectedUsers = selectedUsers.filter(u => u.id !== userId);
            renderSelectedUsers();
        }

        async function createNewChat() {
            const chatType = document.getElementById('chatType').value;
            const chatName = document.getElementById('chatName').value.trim();
            
            if (selectedUsers.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
                return;
            }
            
            try {
                const memberIds = selectedUsers.map(u => u.id);
                
                const response = await fetch('/api/chat/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: chatType,
                        name: chatName,
                        members: memberIds
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
                    closeCreateChat();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    await loadChats();
                    
                    // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
                    setTimeout(() => {
                        const chatNameToShow = chatName || selectedUsers[0]?.username || '–ù–æ–≤—ã–π —á–∞—Ç';
                        selectChat(data.chat_id, chatNameToShow);
                    }, 500);
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞', 'error');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
                if (diffDays < 7) return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
                
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short'
                });
            } catch (e) {
                return '';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'error') icon = 'fas fa-exclamation-circle';
            
            notification.innerHTML = `
                <i class="${icon}"></i>
                <span>${escapeHtml(message)}</span>
            `;
            
            notification.classList.add('show');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        async function logout() {
            try {
                await fetch('/api/logout', {method: 'POST'});
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
            }
            
            // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            localStorage.removeItem('deeplink_user');
            localStorage.removeItem('deeplink_theme');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            location.reload();
        }

        function handleGlobalSearch() {
            const query = document.getElementById('globalSearch').value.trim();
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —á–∞—Ç–∞–º
            console.log('–ü–æ–∏—Å–∫:', query);
        }

        function openChatInfo() {
            if (!currentChatId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'info');
                return;
            }
            showNotification('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ', 'info');
        }

        function openEmojiPicker() {
            showNotification('–í—ã–±–æ—Ä —ç–º–æ–¥–∑–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏', 'info');
        }

        function openFilePicker() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file || !currentChatId || !socket) return;
                
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    socket.emit('send_message', {
                        chat_id: currentChatId,
                        content: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                        type: 'image',
                        media_url: e.target.result
                    });
                    showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function replyToMessage(messageId) {
            showNotification('–§—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏', 'info');
        }

        function updateChatInList(chatId, lastMessage) {
            const chatItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
            if (chatItem) {
                const lastMessageEl = chatItem.querySelector('.last-message');
                if (lastMessageEl) {
                    lastMessageEl.textContent = lastMessage;
                }
                
                const timeEl = chatItem.querySelector('.chat-time');
                if (timeEl) {
                    timeEl.textContent = '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —á–∞—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
                const container = document.getElementById('chatsList');
                if (chatItem.parentNode === container) {
                    container.insertBefore(chatItem, container.firstChild);
                }
            }
        }

        function updateUserStatus(data) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ UI
            console.log('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω:', data);
        }
    </script>
</body>
</html>
